[{"id":"4a6bf71e.2508","type":"tab","label":"Flow 3","disabled":false,"info":""},{"id":"bc4d9cc8.94ddc","type":"watson-conversation-v1","z":"4a6bf71e.2508","name":"","workspaceid":"a288ad75-7f53-4fa9-8e34-3df953691aea","multiuser":true,"context":true,"empty-payload":false,"default-endpoint":true,"service-endpoint":"","timeout":"","optout-learning":false,"x":643.857177734375,"y":182.28570556640625,"wires":[["ca6e74fc.6598f8","8159cdb4.ddb778"]]},{"id":"ce430d5d.6d98c8","type":"watson-speech-to-text","z":"4a6bf71e.2508","name":"","alternatives":"","speakerlabels":false,"smartformatting":false,"lang":"en-US","langhidden":"en-US","langcustomhidden":"","band":"BroadbandModel","bandhidden":"","password":"FUCbl5WWa5C1","payload-response":false,"streaming-mode":false,"streaming-mute":false,"discard-listening":false,"disable-precheck":false,"default-endpoint":true,"service-endpoint":"","x":316.857177734375,"y":63.28571319580078,"wires":[["c487e4d1.209078"]]},{"id":"6edd8b76.ed4dac","type":"watson-text-to-speech","z":"4a6bf71e.2508","name":"","lang":"en-GB","langhidden":"en-GB","langcustomhidden":"","voice":"en-GB_KateVoice","voicehidden":"","format":"audio/wav","password":"FUCbl5WWa5C1","payload-response":false,"default-endpoint":false,"service-endpoint":"","x":557.857177734375,"y":371.28570556640625,"wires":[["5d42c3d8.423d2c"]]},{"id":"c487e4d1.209078","type":"function","z":"4a6bf71e.2508","name":"set payload","func":"msg.payload = msg.transcription;\n\n\nreturn msg;","outputs":1,"noerr":0,"x":537.857177734375,"y":63.28572082519531,"wires":[["c383e6b.1ab1298"]]},{"id":"5d42c3d8.423d2c","type":"function","z":"4a6bf71e.2508","name":"Set payload","func":"msg.payload = msg.speech;\nreturn msg;","outputs":1,"noerr":0,"x":779.857177734375,"y":370.28570556640625,"wires":[["ee3d7abc.445d38"]]},{"id":"52a2c138.0de","type":"watson-conversation-v1","z":"4a6bf71e.2508","name":"","workspaceid":"59b67fe8-276f-42f9-8ebf-5bea35ff29ac","multiuser":true,"context":true,"x":628.1904907226562,"y":1580.0357460975647,"wires":[["a93f4628.becb48"]]},{"id":"88f3a87d.2554c","type":"inject","z":"4a6bf71e.2508","name":"","topic":"","payload":"hello","payloadType":"str","repeat":"","crontab":"","once":false,"x":219.19049072265625,"y":1498.0357460975647,"wires":[["1499fd35.651c5b"]]},{"id":"d905814d.5bbb58","type":"inject","z":"4a6bf71e.2508","name":"","topic":"","payload":"watson","payloadType":"str","repeat":"","crontab":"","once":false,"x":219.69049072265625,"y":1535.0357460975647,"wires":[["1499fd35.651c5b"]]},{"id":"1499fd35.651c5b","type":"function","z":"4a6bf71e.2508","name":"set user 1","func":"msg.user = '1';\n\nreturn msg;","outputs":1,"noerr":0,"x":390.69049072265625,"y":1534.0357460975647,"wires":[["52a2c138.0de"]]},{"id":"91c27919.d924b","type":"inject","z":"4a6bf71e.2508","name":"","topic":"","payload":"hello","payloadType":"str","repeat":"","crontab":"","once":false,"x":218.19049072265625,"y":1619.0357460975647,"wires":[["e57f6637.7ff72"]]},{"id":"798d074.f9335f8","type":"inject","z":"4a6bf71e.2508","name":"","topic":"","payload":"cics","payloadType":"str","repeat":"","crontab":"","once":false,"x":218.69049072265625,"y":1655.0357460975647,"wires":[["e57f6637.7ff72"]]},{"id":"e57f6637.7ff72","type":"function","z":"4a6bf71e.2508","name":"set user 2","func":"msg.user = '2';\n\nreturn msg;","outputs":1,"noerr":0,"x":389.69049072265625,"y":1654.0357460975647,"wires":[["52a2c138.0de"]]},{"id":"a93f4628.becb48","type":"debug","z":"4a6bf71e.2508","name":"","active":true,"console":"false","complete":"payload.output.text","x":847.1904907226562,"y":1580.0357460975647,"wires":[]},{"id":"403081f2.41187","type":"inject","z":"4a6bf71e.2508","name":"","topic":"","payload":"hello","payloadType":"str","repeat":"","crontab":"","once":false,"x":395.19049072265625,"y":1401.0357460975647,"wires":[["52a2c138.0de"]]},{"id":"d224c84.b408d38","type":"inject","z":"4a6bf71e.2508","name":"","topic":"","payload":"watson","payloadType":"str","repeat":"","crontab":"","once":false,"x":395.19049072265625,"y":1437.0357460975647,"wires":[["52a2c138.0de"]]},{"id":"3e5dd84f.3ec7a8","type":"inject","z":"4a6bf71e.2508","name":"","topic":"","payload":"hello","payloadType":"str","repeat":"","crontab":"","once":false,"x":266.69049072265625,"y":1749.0357460975647,"wires":[["7bc8102.ac4a7f"]]},{"id":"7bc8102.ac4a7f","type":"function","z":"4a6bf71e.2508","name":"reset context","func":"msg.params = {\n    context: {}\n};\n\nreturn msg;","outputs":1,"noerr":0,"x":411.69049072265625,"y":1749.0357460975647,"wires":[["52a2c138.0de"]]},{"id":"dfceb5d4.aeba9","type":"inject","z":"4a6bf71e.2508","name":"","topic":"","payload":"yes","payloadType":"str","repeat":"","crontab":"","once":false,"x":219.69049072265625,"y":1571.0357460975647,"wires":[["1499fd35.651c5b"]]},{"id":"580360ed.4fdaf8","type":"inject","z":"4a6bf71e.2508","name":"","topic":"","payload":"yes","payloadType":"str","repeat":"","crontab":"","once":false,"x":218.19049072265625,"y":1691.0357460975647,"wires":[["e57f6637.7ff72"]]},{"id":"1bd463d3.3e0504","type":"inject","z":"4a6bf71e.2508","name":"","topic":"","payload":"yes","payloadType":"str","repeat":"","crontab":"","once":false,"x":395.19049072265625,"y":1473.0357460975647,"wires":[["52a2c138.0de"]]},{"id":"c7341739.94b348","type":"debug","z":"4a6bf71e.2508","name":"Tone analyzer debug output","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":152.857177734375,"y":234.28570556640625,"wires":[]},{"id":"ecdd0f2f.8f5cb","type":"watson-tone-analyzer-v3","z":"4a6bf71e.2508","name":"","tones":"all","sentences":"true","contentType":"false","tone-method":"generalTone","interface-version":"2016-05-19","inputlang":"en","default-endpoint":true,"service-endpoint":"","x":127.857177734375,"y":183.28570556640625,"wires":[["688bfa6f.7b1c8c","c7341739.94b348"]]},{"id":"688bfa6f.7b1c8c","type":"function","z":"4a6bf71e.2508","name":"add emotion to context","func":"var emotions = [];\nvar threshold = 0.5;\nvar topemotion ='';\n\n// simplify object returned by tone analyser to only the emotion tones\nemotions = msg.response.document_tone.tone_categories\n                .filter(function(c){\n                    if (c.category_id == \"emotion_tone\")\n                    {return c; }\n                    })[0].tones;\n                    \n\nnode.warn(\"Detected tones: \\n\" + JSON.stringify(emotions));\n\n// find highest score and return that tone name, if that score is greater than the threshold\ntopemotion = emotions.reduce(function(a, b){ return a.score > b.score ? a : b; });\n\nif (topemotion.score > threshold) {\n    topemotion = topemotion.tone_name;\n} else {\n    topemotion = \"neutral\";\n}\n\n\n// add top emotion to conversation context\nmsg.additional_context = { emotion: topemotion };\n\nnode.warn(\"Emotion added to conversation context:\\n   \" +  topemotion);    \n\n\nreturn msg;\n","outputs":1,"noerr":0,"x":395.857177734375,"y":183.28570556640625,"wires":[["bc4d9cc8.94ddc","f8b9cdbe.4ce598"]]},{"id":"ca6e74fc.6598f8","type":"function","z":"4a6bf71e.2508","name":"set payload and tweet","func":"/*output=msg.payload;\nmsg.payload = {};\nmsg.payload.output = {text: [output]}\nmsg.payload.context={twitter: {handle:\"@lindacmgross1\",DM:true}}\nnode.warn(msg.payload.context);\n*/\nnode.warn(\"Conversation output is:\\n\" + JSON.stringify(msg.payload))\n\nif (msg.payload.output && msg.payload.output.text) {\n    output = msg.payload.output.text.join(' ');\n    \n    output = output.split('|')\n    .filter(function(c) {\n        return c.indexOf(\"tweet:\") === -1 && c.indexOf(\"link:\") === -1;\n    }).join(' ');\n} else {\n    output = 'No response';\n}\n\nnode.warn(\"Cleaned conversation output: \\n\" + output)\nmsg.payload = output;\nnode.send([null,msg]);","outputs":2,"noerr":0,"x":888.857177734375,"y":180.28570556640625,"wires":[[],["6edd8b76.ed4dac"]]},{"id":"c383e6b.1ab1298","type":"function","z":"4a6bf71e.2508","name":"set payload","func":"incoming = msg.payload;\n\nif (incoming && incoming.indexOf(\"weather\") > -1) {\n      incoming =  incoming.split(\" \").filter(function(c) {\n        return c.indexOf(\"weather\") != -1;\n    }).join(' ');\n    msg.payload = incoming;\n} else {\n    msg.payload = incoming;\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":737.857177734375,"y":63.28572082519531,"wires":[["dc0b1737.0257e"]]},{"id":"eec53a85.a8eca8","type":"microphone","z":"4a6bf71e.2508","name":"","x":126.857177734375,"y":64.28571319580078,"wires":[["ce430d5d.6d98c8"]]},{"id":"dc0b1737.0257e","type":"function","z":"4a6bf71e.2508","name":"Device payload","func":"msg = {\n  payload: JSON.stringify(\n    {\n      d:{\n        \"audio\" : msg.payload\n      }\n    }\n  )\n};\nreturn msg;\n","outputs":1,"noerr":0,"x":995.857177734375,"y":64.28570556640625,"wires":[["98dca021.c8cc7","ecdd0f2f.8f5cb"]]},{"id":"98dca021.c8cc7","type":"debug","z":"4a6bf71e.2508","name":"Debug output payload","active":false,"console":"false","complete":"payload","x":1011.857177734375,"y":136.28570556640625,"wires":[]},{"id":"cc1cf68.2c55788","type":"comment","z":"4a6bf71e.2508","name":"Say: 1) \"turn on lights\" or 2) \"turn off lights\" or 3) \"play music\" ","info":"","x":556.857177734375,"y":504.28570556640625,"wires":[]},{"id":"ee3d7abc.445d38","type":"play audio","z":"4a6bf71e.2508","name":"","voice":"0","x":992.857177734375,"y":369.28570556640625,"wires":[]},{"id":"8159cdb4.ddb778","type":"debug","z":"4a6bf71e.2508","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":650.5,"y":239,"wires":[]},{"id":"f8b9cdbe.4ce598","type":"debug","z":"4a6bf71e.2508","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":417.5,"y":238,"wires":[]}]